 {% extends "dashboard.html" %} {% set title=" Product " %} {% if products %} {% set bc_text = products.id %} {% else %}
{% set bc_text = 'Baru' %} {% endif %} {% set breadcrumbs = [ {'link': base_url~'index.php/manage_products','text': res.string.product
}, {'link':'#','text':bc_text }] %} {% block content %}
<div class="row">
	<div class="col-md-12 col-sm-12 col-xs-12">
		<form id="form_Product" method="post" action="{{base_url}}index.php/manage_products/write/{{ products.id }}" data-parsley-validate
		    class="form-horizontal form-label-left">
			<div class="box box-info">
				<div class="box-header with-border">
					{% include 'common/_form_header.html' with {'back_url':'/index.php/manage_products'~back_link, 'title': res.string.product,
					'delete_url':'/index.php/manage_products/delete/'~products.Id, 'object':products} %}
				</div>
				<div class="box-body">
					<div class="row">
						<div class="col-sm-6">
  							<div class="form-group">
  								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.name}}</label>
  								<div class="col-md-6 col-sm-6 col-xs-12">
  									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
  										<input type="text" id="Name" value="{{ products.Name?products.Name:new_number }}" name="Name" required="required" class="form-control  col-md-7 col-xs-12">
  									</div>
  									{% if products %}
  									<p class="control-value">{{ products.Name }}</p>
  									{% endif %}
  								</div>
  							</div>

							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.description}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="text" id="Description" value="{{ products.Description }}" name="Description" required="required" class="form-control  col-md-7 col-xs-12">
									</div>
									{% if products %}
									<p class="control-value">{{ products.Description }}{{products.IsRound?' (Rounded) ':''}}</p>
									{% endif %}
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.is_kdn}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="checkbox" id="IsKdn" value="1" {{ products.IsKdn ? "checked": "" }} name="IsKdn" class="form-checkbox">
									</div>
									{% if products %}
									<p class="control-value">{{ products.IsKdn ? res.string.yes : res.string.no }}</p>
									{% endif %}
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.is_flegt}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="checkbox" id="IsFlegt" value="1" {{ products.IsFlegt ? "checked": "" }} name="IsFlegt" class="form-checkbox">
									</div>
									{% if products %}
									<p class="control-value">{{ products.IsFlegt ? res.string.yes : res.string.no }}</p>
									{% endif %}
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.has_component}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="checkbox" id="HasComponent" value="1" {{ products.HasComponent ? "checked": "" }} name="HasComponent" class="form-checkbox">
									</div>
									{% if products %}
									<p class="control-value">{{ products.HasComponent ? res.string.yes : res.string.no }}</p>
									{% endif %}
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.is_round}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="checkbox" id="IsRound" value="1" {{ products.IsRound ? "checked": "" }} name="IsRound" class="form-checkbox">
									</div>
									{% if products %}
									<p class="control-value">{{ products.IsRound ? res.string.yes : res.string.no }}</p>
									{% endif %}
								</div>
							</div>
						</div>
						<div class="col-sm-6">

              <div class="form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.qty_per_pack}}</label>
                <div class="col-md-6 col-sm-6 col-xs-12">
                  <div {% if products %}style="display:none" {% endif %} class="input-wrap">
                    <input type="number" id="QtyPerPack" value="{{ products.QtyPerPack }}" name="QtyPerPack" required="required" class="form-control  col-md-7 col-xs-12">
                  </div>
                  {% if products %}
                  <p class="control-value">{{ products.QtyPerPack }}</p>
                  {% endif %}
                </div>
              </div>

              <div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.net_cubic}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="number" id="NetCubic" value="{{ products.NetCubic }}" name="NetCubic" required="required" class="form-control col-md-7 col-xs-12">
									</div>
									{% if products %}
									<p class="control-value">{{ products.NetCubic }}</p>
									{% endif %}
								</div>
							</div>
              <div class="form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.net_weight}}</label>
                <div class="col-md-6 col-sm-6 col-xs-12">
                  <div {% if products %}style="display:none" {% endif %} class="input-wrap">
                    <input type="number" id="NetWeight" value="{{ products.NetWeight }}" name="NetWeight" required="required" class="form-control col-md-7 col-xs-12">
                  </div>
                  {% if products %}
                  <p class="control-value">{{ products.NetWeight }}</p>
                  {% endif %}
                </div>
              </div>
              <div class="form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.gross_weight}}</label>
                <div class="col-md-6 col-sm-6 col-xs-12">
                  <div {% if products %}style="display:none" {% endif %} class="input-wrap">
                    <input type="number" id="GrossWeight" value="{{ products.GrossWeight }}" name="GrossWeight" required="required" class="form-control col-md-7 col-xs-12">
                  </div>
                  {% if products %}
                  <p class="control-value">{{ products.GrossWeight }}</p>
                  {% endif %}
                </div>
              </div>

							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.list_price}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if products %}style="display:none" {% endif %} class="input-wrap">
										<input type="number" id="ListPrice" value="{{ products.ListPrice }}" name="ListPrice" required="required" class="form-control  col-md-7 col-xs-12">
									</div>
									{% if products %}
									<p class="control-value">{{ products.ListPrice | monetary }}</p>
									{% endif %}
								</div>
							</div>

              <div id="FrmMaterial" class="form-group" {% if products.HasComponent %}style="display:none"{%endif%}>
                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">{{res.string.material}}</label>
                <div class="col-md-6 col-sm-6 col-xs-12">
                  <div {% if products %}style="display:none" {% endif %} class="input-wrap">
                    {{selection_m2o('ProdMaterial','Material',null,products.MaterialId) | raw }}
                  </div>
                  {% if products %}
                  <p class="control-value">{{ products.Material.Name }}</p>
                  {% endif %}
                </div>
              </div>


						</div>

					</div>
					<div class="row">
						<div class="col-sm-12">

							<div class="nav-tabs-custom">
								<ul class="nav nav-tabs">
									<li class="active">
										<a href="#tab_1" data-toggle="tab">{{res.string.dimension}}</a>
									</li>
									<li>
										<a href="#tab_2" data-toggle="tab">{{ res.string.image }}</a>
									</li>
									<li id="component_tab">
										<a href="#tab_3" data-toggle="tab">{{ res.string.component }}</a>
									</li>
									<li>
										<a href="#tab_4" data-toggle="tab">{{ res.string.finishing }}</a>
									</li>
									<li>
										<a href="#tab_5" data-toggle="tab">{{ res.string.note }}</a>
									</li>
                  {% if products %}
									<li>
										<a href="#tab_6" data-toggle="tab">{{ res.string.buy_price }}</a>
									</li>
                  {% endif %}
								</ul>
								<div class="tab-content">
                  <!-- /.tab-pane -->
									<div class="tab-pane clearfix active" id="tab_1">
                    {% include "admin/products/_dimension_tab.html"%}
									</div>
									<!-- /.tab-pane -->
									<div class="tab-pane" id="tab_2">
                    {% include "admin/products/_prod_img_tab.html"%}
                  </div>
									<!-- /.tab-pane -->
									<div class="tab-pane" id="tab_3">
                    {% include "admin/products/_components_tab.html"%}
                  </div>
									<!-- /.tab-pane -->
									<div class="tab-pane" id="tab_4">
                    {% include "admin/products/_finishing_tab.html"%}
                  </div>
									<!-- /.tab-pane -->
									<div class="tab-pane" id="tab_5">
                    {% include "admin/products/_note_tab.html"%}
                  </div>
									<!-- /.tab-pane -->
                  {% if products %}
									<div class="tab-pane" id="tab_6">
                    {% include "admin/products/_buying_price_tab.html"%}
                  </div>
                  {% endif %}
								</div>
							</div>
						</div>
					</div>
				</div>
		</form>
		</div>
	</div>

	<!-- Modal -->

	{% endblock %} {% block bottom%} {% include 'common/_img_upload_modal.html'%}
  {% include "admin/components/_modal.html" %}
	<script>
  var prod_comp = $('#table_ProductComponent').DataTable({
    'ordering':false,
    'searching':false
  })
		$(document).ready(function () {
			$('input:checkbox').trigger('change')
      $('#MaterialId').on("select2:opening", function() {
        setTimeout(function(){
          if($('.select2-dropdown').find('.select2-add').length < 1){
            $('.select2-dropdown').append('<span class="select2-add"><a onclick="create_new_material()" class="btn btn-select2-new" style="width:100%" href="#">Add new</a></span>')
          }
        }, 500);
      });

		})

    function create_new_material(){
      $('#MaterialId').select2('close');
      $('#MaterialId').parents('.input-wrap').hide()
      $('#Material').show()
      $('#Material').find('input').focus()
    }

		$('#IsKdn').change(function (e) {
      $('.form-knockdown').toggle($(this).prop('checked'))
		})
		$('#HasComponent').change(function (e) {
      $('#component_tab').toggle($(this).prop('checked'))
      $('#FrmMaterial').toggle(!$(this).prop('checked'))
		})
		$('#IsRound').change(function (e) {
      $('.WCol').toggle(!$(this).prop('checked'))
		})
    $('#BuyPriceList').loadTableData({
      order:{
        col:2,
        order:"asc"
      }
    })


		$('.form-dimension-input').on('change keyup paste', function () {
			var r = 1;
			var b = $(this).parents('.form-dimension');

      var w = b.find('.inp-w').val()
      var h = b.find('.inp-h').val()
      var d = b.find('.inp-d').val()
      r = vol_balok(w,h,d)
			b.find('.form-dimension-result').val(r)
		})

    function vol_balok(w,h,d){
      return w*h*d
    }

    function vol_tabung(h,d){
      var r = d/2;
      return h*d*d;
    }

    	var imgProd = []
    	var compProd = []
      var idx = 0


      //Image!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    $('.img-list').on('click','.close-img',function(e){
      e.preventDefault()
      var imgo = $(this).parents('.image')
      imgo.remove()
      if(imgo.data('id')){
        imgProd.push({
            'index':idx,
            'id':imgo.data('id'),
            'state':'delete'
          })
          idx = idx+1
      }else{
        imgProd.splice(imgProd.map(function(x) {return x.index; }).indexOf(imgo.data('index')),1)
      }
			$('#imgProduct').val(JSON.stringify(imgProd))
    })
		$('#btnSaveImgProduct').click(function(e){
    	e.preventDefault()
			imgProd.push({
          'index':idx,
					'name':$('#prodImagesName').val(),
					'url':$('#Image').val(),
					'description':$('#prodImagesDescription').val(),
					'product_id':'{{products.Id}}',
          'state':'new'
				})
        $('.preview-image').prop('src','/public/upload/images/default-thumbnail.jpg')
			$('#imgProduct').val(JSON.stringify(imgProd))
      idx = idx+1
$('.img-list').append('<div data-index="'+idx+'" class="image col-sm-2 col-xs-6">'+
'<a class="close close-img">&times;</a>'+
'<a href="#" data-toggle="modal" class="thumbnail prod-image-thumbnail" data-target="#modalImgProduct">'+
'<img class="" src="'+$('#Image').val()+'"/></a>'+
'</div>	')

		})
//TODO:Problem with index, fix later
    $('#btnSaveComponent').click(function(e){
      e.preventDefault()
      var cp = $('#displayComponentId').val().split('-')
      var nc = {
        index:idx,
        component_id:$('#ComponentId').val(),
        component_name: cp[0],
        material: cp[1],
        qty:$('#Qty').val(),
        state:'new'
      };
      compProd.push(nc)
      idx = idx+1;
      prod_comp.row.add([nc.component_name,nc.material,nc.qty,'<a href="#" data-idx="'+idx+'" class="btn btn-danger btn-delete-row"><i class="fa fa-trash"></i></a>']).draw()
      $('#productComponents').val(JSON.stringify(compProd))
    })
    $('#table_ProductComponent').on( 'click','.btn-delete-row',function(e){
      e.preventDefault()
      var oidx = $(this).data('idx')
      if($(this).data('id')){
        compProd.push({
          id:$(this).data('id'),
          index:idx,
          state:'delete'
        })
        idx = idx+1
      }else{
        compProd.splice(compProd.map(function(x) {return x.index; }).indexOf(oidx),1)
      }
      $('#productComponents').val(JSON.stringify(compProd))
      prod_comp.row( $(this).parents('tr') )
        .remove()
        .draw();
    })
	</script>

	{% endblock %}
