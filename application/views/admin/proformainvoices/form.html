 {% extends "dashboard.html" %} {% set title=" Proforma Invoice " %} {% if proformainvoices %} {% set bc_text = proformainvoices.id %} {% else %} {% set bc_text = res.string.new %} {% endif %} {% set breadcrumbs = [ {'link': base_url~'index.php/manage_proformainvoices','text':
res.string.proforma_invoice }, {'link':'#','text':bc_text }] %} {% block content %}
<div class="row">
	<div class="col-md-12 col-sm-12 col-xs-12">
		<form id="form_ProformaInvoice" method="post" action="{{base_url}}index.php/manage_proformainvoices/write/{{ proformainvoices.id }}" data-parsley-validate class="form-horizontal form-label-left">
			<div class="box box-info">
				<div class="box-header with-border">
					{% include 'common/_form_header.html' with {'back_url':'/index.php/manage_proformainvoices'~back_link, 'title': res.string.proforma_invoice, 'delete_url':'/index.php/manage_proformainvoices/delete/{{ proformainvoices.Id }}', 'object':proformainvoices}
					%}
				</div>
        <input type="hidden" id="PIId" value="{{ proformainvoices.Id }}">
				<div class="box-body">
					<div class="row">
						<div class="col-sm-6">
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="Name">{{res.string.article_number}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
                  <div {% if proformainvoices %}style="display:none"{%else%}class="input-wrap "{% endif %}>
										<input type="text" placeholder="{{ res.string.name }}" value="{{ proformainvoices?proformainvoices.Name:code  }}" name="Name" class="form-control  col-md-7 col-xs-12">
									</div>
									{% if proformainvoices %}
									<p data-fieldname="Name" class="value">{{ proformainvoices.Name }}</p>
									{% endif %}
								</div>
							</div>

							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="CustomerId">{{res.string.customer}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if proformainvoices %}style="display:none"{%else%}class="input-wrap input-group "{% endif %}>
										<input type="hidden" type="text" id="CustomerId" value="{{ proformainvoices.CustomerId }}" name="CustomerId">
										<input type="text" required="required" name="displayCustomerId" id="displayCustomerId" placeholder="{{ res.string.customer }}" value="{{ proformainvoices.Partner.Name }}" class="form-control" />
										<span class="input-group-btn">
    								<button class="btn btnModal btn-default" id="btnCustomerId"  data-target="ModalCustomer" type="button">{{res.string.search}}</button>
    							</span>
									</div>
									{% if proformainvoices %}
									<p data-fieldname="Partner.Name" class="value">{{ proformainvoices.Partner.Name }}</p>
									{% endif %}
								</div>
							</div>
						</div>

						<div class="col-sm-6">
							<div class="form-group">
								<label class="control-label col-md-3 col-sm-3 col-xs-12" for="Date">{{res.string.date}}</label>
								<div class="col-md-6 col-sm-6 col-xs-12">
									<div {% if proformainvoices %}style="display:none" {% endif %} class="input-wrap">
										<input type="text" placeholder="{{ res.string.date }}" id="Date" value="{{ proformainvoices.Date  | date('Y/m/d') }}" name="Date" class="form-control input-date col-md-7 col-xs-12">
									</div>
									{% if proformainvoices %}
									<p data-fieldname="Date" class="control-value">{{ proformainvoices.Date | date('d M Y') }}</p>
									{% endif %}
								</div>
							</div>
						</div>
          <div class="col-sm-6">
            <div class="form-group">
              <label class="control-label col-md-3 col-sm-3 col-xs-12" for="Date">{{res.string.currency}}</label>
              <div class="col-md-6 col-sm-6 col-xs-12">
                <div {% if proformainvoices %}style="display:none" {% endif %} class="input-wrap">
                  {{selection_m2o('CurrencyId','Currency',null,proformainvoices.CurrencyId)| raw}}
                </div>
                {% if proformainvoices %}
                <p data-fieldname="Date" class="control-value">{{ proformainvoices.Currency.Name }}</p>
                {% endif %}
              </div>
            </div>
          </div>
					</div>

            <textarea name="Lines" style="display:none" id="Lines"></textarea>
          <div class="row" id="detail">
            <div class="col-sm-12">
              <div class="nav-tabs-custom">
                <ul class="nav nav-tabs">
                  <li class="active">
                    <a href="#tab_1" data-toggle="tab">{{res.string.proforma_invoice_line}}</a>
                  </li>
                </ul>
                <div class="tab-content">
                  <!-- /.tab-pane -->
                  <div class="tab-pane clearfix active" id="tab_1">
                    {% include "admin/proformainvoices/_proforma_invoice_line_tab.html"%}
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>
			</div>
		</form>
	</div>
</div>
<!-- Modal -->
{% include "admin/proformainvoices/_modal_add_pi_line.html"%}
{% include "admin/customers/_modal.html" %}
{% include "admin/products/_modal.html" %} {% endblock %}

{% block bottom %}
{% include "common/_modal_notice.html" %}
<script>
var Lines = [];
var idx =0;

function refresh_line(){
  $('#table_ProformaInvoiceLine').DataTable().ajax.reload(function(d){
      console.log("reload dttable");
      get_total()
      $('#ModalAddProformaInvoiceLine').find('input').val('')
      $('#ModalAddProformaInvoiceLine').find('input').checked = false;
      $('#ModalAddProformaInvoiceLine').modal('hide')
      $('#table_ProformaInvoiceLine').find('.btn-delete').show()
      $('#table_ProformaInvoiceLine').find('.btn-edit').show()
  })
}
$(document).ready(function(){
  $('#table_ProformaInvoiceLine').on('click','.btn-delete',function(e){
    $.ajax({
      url:'/index.php/manage_proformainvoicelines/delete/'+$(this).data('id'),
      data:'&confirm=1',
      method:'POST'
    }).done(function(o){
      refresh_line()
    })
  })

  $('#table_ProformaInvoiceLine').on('click','.btn-edit',function(e){
    $.ajax({
      url:'/index.php/manage_proformainvoicelines/detail/'+$(this).data('id'),
      method:'GET',
      dataType:'JSON'
    }).done(function(o){
      console.log(o);
      $('#LineId').val(o.Id)
      $('#ModalAddProformaInvoiceLine').find('input').each(function(i){

        if(o.hasOwnProperty($(this).prop('name'))){
          switch ($(this).prop('type')) {
            case 'text':
              $(this).val(o[$(this).prop('name')])
              break;
            case 'hidden':
              $(this).val(o[$(this).prop('name')])
              break;
            case 'number':
              $(this).val(o[$(this).prop('name')])
              break;
            case 'checkbox':
              $(this).checked = o[$(this).prop('name')]
              break;
            default:
          }
          $(this).change();

        }else{
          console.log("dont have");
        }

        $('#Finishing').data('value',o.ProductFinishing)

      })

      $('#ModalAddProformaInvoiceLine').modal('show')
    })
  })
  $('#form_ProformaInvoiceLine').submit(function(e){
    e.preventDefault()
    if($('#PIId').val()>0){
        console.log('hahahahahha');
          write_line($('#PIId').val()).done(function(o){
            refresh_line()
          })
    }else{
      write_pi().done(function(o){
        write_line(o.Id).done(function(o){
          location.reload();
        })
      })

    }
  })
  $('#btnOpenAddLine').click(function(e){
      if($('#CustomerId').val()>0 ){
        $('#LineId').val("")
        $('#ModalAddProformaInvoiceLine').modal('show')
      }else{
        notice_popup('Please specify the customer first')
      }
  })
  $('#Price').on('keyup change',function(e){
    var disc = 0;
    var price = $(this).val()
    var normal_price = $('#ListPrice').val()
    var gap = normal_price - price
    $('#CalculatedDiscount').val(((gap/normal_price)*100).toFixed(2))
  })

    $('#table_ProformaInvoiceLine').loadTableData({
      button:['edit','delete'],
      complete:function(settings, json) {
        console.log("complete");

          get_total()
        $('#table_ProformaInvoiceLine').css('width','100%')
      }
    })


    $('.pi_lines').simpleValidation()
  })

  $('#ProductId').change(function(){
    console.log("prod changed");
      $.ajax({
        url:'/index.php/manage_products/get_detail_json/'+$(this).val()+
        '?customer_id='+$('#CustomerId').val()+'&currency_id='+$('#CurrencyId').val(),
        dataType:'JSON',
        success:function(o){
          var art = o.Name
          var price = o.ListPrice
          var desc = o.Description
          var sdf= []
          for (var f in o.Finishings) {
            sdf.push({
              id:o.Finishings[f].Name,
              text:o.Finishings[f].Name
            })
          }
          repopulate_select2('#Finishing',sdf)
          $('#Finishing').val(function(){
            return $(this).data('value')
          }).trigger('change');
          if(o.ProductPartners){
            price = o.ProductPartners[0].ProductPrice
            art = o.ProductPartners[0].Name
            desc = o.ProductPartners[0].Description
          }

          for (var i in o) {
            if (o.hasOwnProperty(i)) {
              var shouldfill = true
              if($('#LineId').val()>1){
                if(i != 'ListPrice'){
                  console.log(i);
                  shouldfill = false
                }
              }
              if(shouldfill){
              $('#'+i).val(o[i])
              }
            }
          }
          console.log(desc);
          $('#CubicDimension').val(o.IsKdn?o.CubicKdn:o.CubicAsb)

          if(!($('#LineId').val()>1)){
            $('#LineName').val(art)
            $('#Description').val(desc)
            $('#Price').val(price)
          }
          $('#displayProductId').val(o.Name+' - '+ o.Description)
          $('#Price').trigger('change')
        }
      })
  })
  function get_total(){
    var tot= 0;
    var ctot = 0;
    $('#table_ProformaInvoiceLine').find('tbody tr').each(function(i){
      var stot = $(this).find("td").eq(8).text();
      var sctot = $(this).find("td").eq(6).text();
      stot = stot.replace(/[^0-9-,]/g, '')
      stot = stot.match(/[+-]?\d+(\.\d+)?/g).map(function(v) { return parseFloat(v); });
      console.log(stot);
      sctot = sctot.match(/[+-]?\d+(\.\d+)?/g).map(function(v) { return parseFloat(v); });
      // console.log(sctot);
      tot = tot + (stot[0]>0?(stot[0]*1):0)
      ctot = ctot +(sctot[0]>0?(sctot[0]*1):0)
    })
    $('#TotalCol').text(format_currency(tot,{
      "symbol":"{{ proformainvoices.Currency.Symbol }}",
      "rate":"{{ exchange_rate(1,proformainvoices.Currency.Code) }}",
      "position":"{{ proformainvoices.Currency.Placement }}"}
    ))
    $('#TotalCd').text(parseFloat(ctot).toFixed(3) + ' m3')
  }

  $('#table_ProformaInvoiceLine').on( 'click','.btn-delete-row',function(e){
    e.preventDefault()
    console.log('hahahahahah');
    var oidx = $(this).data('index')
    mod_line({
      id:$(this).data('id'),
      index:$(this).data('index'),
      _selector:this
    },'delete')
  })
  var edrow = false;



    function write_pi(){
      var frm = $('#form_ProformaInvoice')
      return $.ajax({
        url:frm.prop('action'),
        method:'POST',
        dataType:"JSON",
        data:frm.serialize()
      })
    }

    function write_line(pi_id,id=''){
      var frm = $('#form_ProformaInvoiceLine')
      return $.ajax({
        url:frm.prop('action')+$('#LineId').val()+"?proforma_invoice_id="+pi_id,
        method:'POST',
        dataType:"JSON",
        data:frm.serialize()+'&ProformaInvoiceId='+pi_id
      })
    }
</script>
{% endblock %}
